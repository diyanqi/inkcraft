import { NextRequest, NextResponse } from "next/server";
import { CorrectionUtil } from "@/utils/corrections";
import { auth } from "@/auth";
import { createOpenAI } from '@ai-sdk/openai';
import { generateText } from 'ai';

const openai = createOpenAI({
  baseURL: process.env.OPENAI_API_BASEURL || '',
  apiKey: process.env.OPENAI_API_APIKEY || '',
  compatibility: 'compatible',
});

export async function POST(req: NextRequest) {
  try {
    const session = await auth();
    if (!session || !session.user?.email) {
      return NextResponse.json({ success: false, message: "æœªç™»å½•æˆ–æ— æ•ˆç”¨æˆ·" }, { status: 401 });
    }
    // è·å–å‰ç«¯ä¼ é€’çš„æ•°æ®ï¼ˆå®é™…å¼€å‘ä¸­åº”æ ¡éªŒæ•°æ®ï¼‰
    const body = await req.json();
    // æ ¡éªŒæ•°æ®ï¼šåŒ…å«ï¼šoriginalText, essayText
    if (!body.originalText || !body.essayText || !body.model || !body.essayType || !body.tone) {
      return NextResponse.json({ success: false, message: "ç¼ºå°‘å¿…è¦å‚æ•°" }, { status: 400 });
    }

    let content = "";
    // æ¥ä¸‹æ¥ç”Ÿæˆåˆæ­¥çš„ content
    content = `# 1. é¢˜ç›®\n${body.originalText}\n# 2. æˆ‘çš„ç»­å†™\n${body.essayText}\n`;

    // è°ƒç”¨OpenAI APIï¼Œç”Ÿæˆæ‰¹æ”¹åˆ†æ•°ç»“æœ
    const model = openai('@cf/meta/llama-3.1-8b-instruct-fast');
    const { text } = await generateText({
      model,
      messages: [
        {
          role: 'system',
          content: `"ä½œä¸ºç»éªŒä¸°å¯Œçš„é«˜è€ƒè‹±è¯­ç»­å†™é˜…å·ä¸“å®¶ï¼Œè¯·ä¸¥æ ¼æŒ‰ä»¥ä¸‹ç»†åˆ™å¯¹è¯»åç»­å†™è¯„åˆ†ï¼Œæ¯ä¸ªå­é¡¹éœ€å…ˆè¯´æ˜è¯„åˆ†ç†ç”±å†ç»™å‡ºå…·ä½“åˆ†æ•°ï¼š

1. å†…å®¹ä¸åŸæ–‡èæ´½åº¦ï¼ˆ15åˆ†ï¼‰

â€¢ 1.1 æƒ…èŠ‚è¿è´¯æ€§ï¼ˆ5åˆ†ï¼‰

  â—¦ 5åˆ†ï¼šæ®µé¦–ç”¨æ—¶é—´/åŠ¨ä½œ/ç¯å¢ƒæå†™æ— ç¼è¡”æ¥åŸæ–‡ï¼ˆå¦‚åŸæ–‡ç»“å°¾"midnight"â†’ç»­å†™"At dawn..."ï¼‰

  â—¦ 3åˆ†ï¼šè¡”æ¥åŸºæœ¬åˆç†ä½†ç¼ºä¹è¿‡æ¸¡è¯ï¼ˆç›´æ¥è·³è½¬"Two days later..."ï¼‰

  â—¦ 1åˆ†ï¼šæƒ…èŠ‚æ–­è£‚ï¼ˆå¦‚åŸæ–‡ç´§å¼ åœºæ™¯çªè½¬æ¬¢ä¹æ´¾å¯¹ï¼‰

â€¢ 1.2 äººç‰©ä¸€è‡´æ€§ï¼ˆ5åˆ†ï¼‰

  â—¦ 5åˆ†ï¼šè¨€è¡Œç¬¦åˆåŸæ–‡è®¾å®šï¼ˆå¦‚æ‡¦å¼±è§’è‰²ä¿æŒè°¨æ…ï¼‰

  â—¦ 3åˆ†ï¼šæ¬¡è¦äººç‰©æ€§æ ¼è½»å¾®åå·®ï¼ˆå¦‚æœ‹å‹ä»å®‰é™å˜ä¸ºå¥è°ˆï¼‰

  â—¦ 1åˆ†ï¼šä¸»è§’è¡Œä¸ºä¸¥é‡çŸ›ç›¾ï¼ˆå–„è‰¯è€…æ— æ•…ä¼¤å®³ä»–äººï¼‰

â€¢ 1.3 ä¸»é¢˜å¥‘åˆåº¦ï¼ˆ5åˆ†ï¼‰

  â—¦ 5åˆ†ï¼šæ·±åŒ–åŸæ–‡ä¸»é¢˜ï¼ˆå¦‚"ç¯ä¿"â†’ç»­å†™æ¸…ç†æ±¡æŸ“ï¼‰

  â—¦ 3åˆ†ï¼šä¿æŒä¸»é¢˜ä½†ç¼ºä¹å‘å±•ï¼ˆä»…é‡å¤åŸæ–‡å†…å®¹ï¼‰

  â—¦ 1åˆ†ï¼šåç¦»æ ¸å¿ƒä¸»é¢˜ï¼ˆå¦‚"å‹è°Š"æ•…äº‹çªè½¬å•†ä¸šç«äº‰ï¼‰

2. æƒ…èŠ‚åˆç†æ€§ä¸å®Œæ•´æ€§ï¼ˆ15åˆ†ï¼‰

â€¢ 2.1 å†²çªè§£å†³ï¼ˆ6åˆ†ï¼‰

  â—¦ 6åˆ†ï¼šç”¨ä¼ç¬”è§£å†³çŸ›ç›¾ï¼ˆå¦‚ç”¨å‰æ–‡"åœ°å›¾"è„±å›°ï¼‰

  â—¦ 4åˆ†ï¼šè§£å†³åˆç†ä½†ç¼ºä¹é“ºå«ï¼ˆçªç„¶å‡ºç°æ•‘æ´é˜Ÿï¼‰

  â—¦ 2åˆ†ï¼šæœªè§£å†³å†²çªæˆ–æœºæ¢°é™ç¥ï¼ˆå¤–æ˜Ÿäººæ•‘åœºï¼‰

â€¢ 2.2 ç¬¦åˆå¸¸è¯†ï¼ˆ5åˆ†ï¼‰

  â—¦ 5åˆ†ï¼šç¬¦åˆç‰©ç†/ç¤¾ä¼šè§„åˆ™ï¼ˆé›¨å¤©ç”¨å¡‘æ–™å¸ƒç”Ÿç«ï¼‰

  â—¦ 3åˆ†ï¼šè½»å¾®ç‘•ç–µï¼ˆæ£®æ—ä¸­è½»æ˜“æ‰¾åˆ°è¯å“ï¼‰

  â—¦ 1åˆ†ï¼šä¸¥é‡è¿èƒŒå¸¸è¯†ï¼ˆå¾’æ‰‹å‡»é€€ç‹¼ç¾¤ï¼‰

â€¢ 2.3 ç§¯æç»“å±€ï¼ˆ4åˆ†ï¼‰

  â—¦ 4åˆ†ï¼šè‡ªç„¶ä¼ é€’æ­£èƒ½é‡ï¼ˆäº’åŠ©è„±å›°åå»ºç«‹å‹è°Šï¼‰

  â—¦ 2åˆ†ï¼šç»“å±€ç§¯æä½†çªå…€ï¼ˆç›´æ¥é™ˆè¿°"ä»–ä»¬å¹¸ç¦äº†"ï¼‰

  â—¦ 0åˆ†ï¼šæ¶ˆæç»“å±€ï¼ˆä¸»è§’æ”¾å¼ƒæˆ–æ­»äº¡ï¼‰

3. è¯æ±‡ä¸°å¯Œæ€§ï¼ˆ20åˆ†ï¼‰

â€¢ 3.1 è¯æ±‡å¤šæ ·æ€§ï¼ˆ8åˆ†ï¼‰

  â—¦ 8åˆ†ï¼šåŒä¹‰è¯æ›¿æ¢â‰¥5å¤„ï¼ˆ"said"â†’whispered/exclaimedï¼‰

  â—¦ 5åˆ†ï¼šæ›¿æ¢3-4å¤„

  â—¦ 2åˆ†ï¼šé‡å¤ä½¿ç”¨åŸºç¡€è¯æ±‡

â€¢ 3.2 ç”¨è¯å‡†ç¡®æ€§ï¼ˆ8åˆ†ï¼‰

  â—¦ 8åˆ†ï¼šæ— ä¸­å¼è‹±è¯­ä¸”æ­é…ç²¾å‡†ï¼ˆ"make a decision"ï¼‰

  â—¦ 5åˆ†ï¼š1-2å¤„é”™è¯¯ï¼ˆè¯¯ç”¨"borrow"ä»£æ›¿"lend"ï¼‰

  â—¦ 2åˆ†ï¼šâ‰¥3å¤„æ­é…é”™è¯¯

â€¢ 3.3 é«˜çº§è¯æ±‡ï¼ˆ4åˆ†ï¼‰

  â—¦ 4åˆ†ï¼šC1+è¯æ±‡â‰¥3ä¸ªï¼ˆresilient, dilemmaï¼‰

  â—¦ 2åˆ†ï¼šä½¿ç”¨1-2ä¸ª

  â—¦ 0åˆ†ï¼šä»…åŸºç¡€è¯æ±‡

4. è¯­æ³•å‡†ç¡®æ€§ï¼ˆ20åˆ†ï¼‰

â€¢ 4.1 ä¸»è°“ä¸€è‡´ï¼ˆ7åˆ†ï¼‰

  â—¦ 7åˆ†ï¼šé›¶é”™è¯¯

  â—¦ 5åˆ†ï¼š1-2å¤„é”™è¯¯ï¼ˆ"She don't know"ï¼‰

  â—¦ 3åˆ†ï¼šâ‰¥3å¤„é”™è¯¯

â€¢ 4.2 æ—¶æ€æ­£ç¡®ï¼ˆ8åˆ†ï¼‰

  â—¦ 8åˆ†ï¼šå…¨æ–‡æ—¶æ€ä¸åŸæ–‡100%ä¸€è‡´

  â—¦ 5åˆ†ï¼š1-2å¤„æ—¶æ€è·³è·ƒï¼ˆè¿‡å»â†’ç°åœ¨æ—¶ï¼‰

  â—¦ 3åˆ†ï¼šâ‰¥3å¤„æ—¶æ€é”™è¯¯

â€¢ 4.3 å¥å­ç»“æ„ï¼ˆ5åˆ†ï¼‰

  â—¦ 5åˆ†ï¼šæ— ç²˜è¿å¥/ç‰‡æ®µå¥

  â—¦ 3åˆ†ï¼š1å¤„ç»“æ„é”™è¯¯ï¼ˆæ— è¿è¯é€—å·è¿æ¥ï¼‰

  â—¦ 1åˆ†ï¼šâ‰¥2å¤„ç»“æ„é”™è¯¯

5. å¥å¼å¤šæ ·æ€§ï¼ˆ10åˆ†ï¼‰

â€¢ 5.1 å¤åˆå¥å æ¯”ï¼ˆ6åˆ†ï¼‰

  â—¦ 6åˆ†ï¼šå¤åˆå¥â‰¥40%ï¼ˆå¦‚å®šè¯­ä»å¥"who..."ï¼‰

  â—¦ 4åˆ†ï¼š30-39%

  â—¦ 2åˆ†ï¼šï¼œ30%

â€¢ 5.2 ç‰¹æ®Šå¥å¼ï¼ˆ4åˆ†ï¼‰

  â—¦ 4åˆ†ï¼šä½¿ç”¨â‰¥2ç§ï¼ˆå€’è£…/å¼ºè°ƒ/ç‹¬ç«‹ä¸»æ ¼ï¼‰

  â—¦ 2åˆ†ï¼šä½¿ç”¨1ç§

  â—¦ 0åˆ†ï¼šæœªä½¿ç”¨

6. è¡”æ¥ä¸è¿è´¯æ€§ï¼ˆ10åˆ†ï¼‰

â€¢ 6.1 æ˜¾æ€§è¡”æ¥ï¼ˆ6åˆ†ï¼‰

  â—¦ 6åˆ†ï¼šè¿‡æ¸¡è¯ä½¿ç”¨â‰¥3æ¬¡ä¸”æ°å½“ï¼ˆhowever/meanwhileï¼‰

  â—¦ 4åˆ†ï¼šä½¿ç”¨1-2æ¬¡

  â—¦ 2åˆ†ï¼šæœªä½¿ç”¨æˆ–è¯¯ç”¨ï¼ˆç”¨"therefore"è¡¨è½¬æŠ˜ï¼‰

â€¢ 6.2 éšæ€§è¡”æ¥ï¼ˆ4åˆ†ï¼‰

  â—¦ 4åˆ†ï¼šä»£è¯æŒ‡ä»£100%æ¸…æ™°ï¼ˆ"they"æ˜ç¡®æŒ‡æ•‘æ´é˜Ÿï¼‰

  â—¦ 2åˆ†ï¼š1-2å¤„æŒ‡ä»£æ¨¡ç³Š

  â—¦ 0åˆ†ï¼šâ‰¥3å¤„æŒ‡ä»£æ··ä¹±

7. åˆ›æ–°æ€§ä¸é€»è¾‘æ€§ï¼ˆ10åˆ†ï¼‰

â€¢ 7.1 ç»†èŠ‚åˆ›æ–°ï¼ˆ5åˆ†ï¼‰

  â—¦ 5åˆ†ï¼šæ·»åŠ â‰¥2ä¸ªåˆç†æ–°å…ƒç´ ï¼ˆé”ˆæŒ‡å—é’ˆ/é‡æœå……é¥¥ï¼‰

  â—¦ 3åˆ†ï¼šæ·»åŠ 1ä¸ªæ–°å…ƒç´ 

  â—¦ 1åˆ†ï¼šæ— æ–°ç»†èŠ‚æˆ–è„±ç¦»é€»è¾‘

â€¢ 7.2 å› æœé€»è¾‘ï¼ˆ5åˆ†ï¼‰

  â—¦ 5åˆ†ï¼šäº‹ä»¶å› æœé“¾å®Œæ•´ï¼ˆå—ä¼¤â†’æ¶ˆæ¯’â†’æ¢å¤ï¼‰

  â—¦ 3åˆ†ï¼šå› æœåŸºæœ¬åˆç†ä½†ç¼ºæ­¥éª¤ï¼ˆç›´æ¥åŒ…æ‰æœªæ¸…æ´ï¼‰

  â—¦ 1åˆ†ï¼šå› æœæ–­è£‚ï¼ˆæœªè§£é‡Šå¦‚ä½•è·æ•‘ï¼‰

8. æ–‡ä½“ä¸äººç§°ä¸€è‡´æ€§ï¼ˆ10åˆ†ï¼‰

â€¢ 8.1 å™è¿°è§†è§’ï¼ˆ5åˆ†ï¼‰

  â—¦ 5åˆ†ï¼šä¸¥æ ¼ä¿æŒåŸæ–‡äººç§°ï¼ˆç¬¬ä¸€äººç§°å…¨ç¨‹"æˆ‘"ï¼‰

  â—¦ 3åˆ†ï¼š1-2å¤„äººç§°åç§»ï¼ˆæ··ç”¨"I"å’Œ"he"ï¼‰

  â—¦ 1åˆ†ï¼šå½»åº•æ”¹å˜è§†è§’

â€¢ 8.2 è¯­ä½“é£æ ¼ï¼ˆ5åˆ†ï¼‰

  â—¦ 5åˆ†ï¼š100%ç¬¦åˆæ•…äº‹æ–‡ä½“ï¼ˆå¯¹è¯ç”¨å¼•å·ï¼Œæ— å­¦æœ¯è¯æ±‡ï¼‰

  â—¦ 3åˆ†ï¼š1-2å¤„é£æ ¼ä¸ç¬¦ï¼ˆç”¨"furthermore"æ›¿ä»£"then"ï¼‰

  â—¦ 1åˆ†ï¼šæ–‡ä½“æ··æ‚ï¼ˆæ’å…¥å®éªŒæ•°æ®è¯´æ˜ï¼‰

æ ‡å‡†åŒ–JSONè¾“å‡º

{  
  "åˆ†é¡¹è¯„åˆ†": {  
    "å†…å®¹ä¸åŸæ–‡èæ´½åº¦": {  
      "æƒ…èŠ‚è¿è´¯æ€§": {  
        "reason": "æ®µé¦–ç”¨'As the rain poured'è¡”æ¥åŸæ–‡æš´é›¨åœºæ™¯ï¼Œä½†ç¼ºä¹æ—¶é—´è¿‡æ¸¡è¯",  
        "score": 3  
      },  
      "äººç‰©ä¸€è‡´æ€§": {  
        "reason": "ä¸»è§’ä¿æŒå‹‡æ•¢è®¾å®šï¼Œä½†æœ‹å‹çªç„¶å†·æ¼ ï¼ˆåŸæ–‡è®¾å®šä¸ºçƒ­æƒ…ï¼‰",  
        "score": 3  
      },  
      "ä¸»é¢˜å¥‘åˆåº¦": {  
        "reason": "æ·±åŒ–'å‹‡æ°”'ä¸»é¢˜ï¼Œé€šè¿‡å…‹æœææƒ§æ¨åŠ¨æˆé•¿",  
        "score": 5  
      }  
    },  
    "æƒ…èŠ‚åˆç†æ€§ä¸å®Œæ•´æ€§": {  
      "å†²çªè§£å†³": {  
        "reason": "ç”¨å‰æ–‡'å“¨å­'å‘å‡ºæ±‚æ•‘ä¿¡å·ï¼Œä¼ç¬”å›æ”¶åˆç†",  
        "score": 6  
      },  
      "ç¬¦åˆå¸¸è¯†": {  
        "reason": "'æ¹¿æœ¨å¤´ç”Ÿç«'è¿åç‡ƒçƒ§å¸¸è¯†",  
        "score": 1  
      },  
      "ç§¯æç»“å±€": {  
        "reason": "ä¼ é€’å¸Œæœ›ä½†è·æ•‘è¿‡ç¨‹ä»“ä¿ƒ",  
        "score": 2  
      }  
    },  
    "è¯æ±‡ä¸°å¯Œæ€§": {  
      "è¯æ±‡å¤šæ ·æ€§": {  
        "reason": "åŒä¹‰è¯æ›¿æ¢4å¤„ï¼ˆshoutedâ†’screamed/criedï¼‰",  
        "score": 5  
      },  
      "ç”¨è¯å‡†ç¡®æ€§": {  
        "reason": "è¯¯ç”¨'receive the prize'åº”ä¸º'win the prize'",  
        "score": 5  
      },  
      "é«˜çº§è¯æ±‡": {  
        "reason": "ä½¿ç”¨'resilient'å’Œ'determination'",  
        "score": 2  
      }  
    },  
    // å…¶ä»–ç»´åº¦åŒç†...  
  }
}  

é‡è¦æé†’ï¼šä½ çš„è¾“å‡ºä»…åŒ…å«JSONæ ¼å¼ï¼Œä¸å…è®¸å‡ºç°å…¶ä»–å­—ç¬¦æˆ–æ³¨é‡Šã€‚`,
        },
        {
          role: 'user',
          content: `# 1. é¢˜ç›®\n${body.originalText}\n# 2. æˆ‘çš„ç»­å†™\n${body.essayText}`,
        },
      ],
      maxTokens: 4096,
      temperature: 0.1,
    });
    // è§£æå­—ç¬¦ä¸²ï¼Œé¦–å…ˆæ‰¾åˆ°jsonæ‰€åœ¨çš„ä½ç½®ï¼ˆä»ç¬¬ä¸€ä¸ª`{`å¼€å§‹ï¼Œåˆ°æœ€åä¸€ä¸ª`}`ç»“æŸï¼‰
    const start = text.indexOf('{');
    const end = text.lastIndexOf('}');
    const jsonString = text.substring(start, end + 1);
    // è§£æJSONå­—ç¬¦ä¸²
    const json = JSON.parse(jsonString);
    // è®¡ç®—æ€»åˆ†
    let totalScore = 0;
    for (const key in json.åˆ†é¡¹è¯„åˆ†) {
      const section = json.åˆ†é¡¹è¯„åˆ†[key];
      for (const subKey in section) {
        totalScore += section[subKey].score;
        content += `\n## ${key}\n${subKey}ï¼š${section[subKey].reason}\n`;
      }
    }
    // 100 åˆ†åˆ¶è½¬æ¢ä¸º 25 åˆ†åˆ¶ï¼Œå¹¶ä¸”ä¿ç•™ä¸€ä½å°æ•°
    const score = Number((totalScore / 100 * 25).toFixed(1));

    const fastModel = openai('@cf/meta/llama-3.1-8b-instruct-fast');
    // ç”Ÿæˆæ ‡é¢˜
    let title = "";
    if (body.title && body.title.length > 0) {
      title = body.title;
    } else {
      // è°ƒç”¨OpenAI APIï¼Œç”Ÿæˆæ ‡é¢˜
      const { text: titleResponse } = await generateText({
        model: fastModel,
        messages: [
          {
            role: 'system',
            content: `ç”¨æˆ·å°†æä¾›ç»™ä½ ä¸€é“è¯»åç»­å†™é¢˜ï¼Œè¯·ä½ åˆ†æé¢˜ç›®å†…å®¹ï¼Œå¹¶æ€»ç»“å‡ºä¸€ä¸ªæ ‡é¢˜ï¼Œè¾“å‡ºæ—¶ä»…åŒ…å«ä¸€è¡Œè¯¥æ ‡é¢˜ï¼Œä¸å…è®¸å‡ºç°å…¶ä»–å­—ç¬¦æˆ–æ³¨é‡Šã€‚`,
          },
          {
            role: 'user',
            content: `è¯»åç»­å†™é¢˜ï¼š\n${body.originalText}`,
          }
        ]
      });
      title = titleResponse;
    }

    // ç”Ÿæˆå›¾æ ‡
    const { text: icon } = await generateText({
      model: fastModel,
      messages: [
        {
          role: 'system',
          content: `ç”¨æˆ·å°†æä¾›ç»™ä½ ä¸€é“è¯»åç»­å†™é¢˜ï¼Œè¯·ä½ åˆ†æé¢˜ç›®å†…å®¹ï¼Œå¹¶è¾“å‡ºä¸€ä¸ªä½ è®¤ä¸ºä¸ä¹‹ç›¸å…³çš„emojiå­—ç¬¦ï¼ˆåªèƒ½ä¸€ä¸ªå­—ç¬¦ï¼Œä¾‹å¦‚ğŸ“ï¼‰ï¼Œå¹¶ä¸”åœ¨è¾“å‡ºæ—¶ä¸å…è®¸å‡ºç°å…¶ä»–å­—ç¬¦æˆ–æ³¨é‡Šã€‚`,
        },
        {
          role: 'user',
          content: `è¯»åç»­å†™é¢˜ï¼š\n${body.originalText}`,
        }
      ]
    });

    const testData = {
      title,
      icon,
      model: body.model || "gpt-4",
      content,
      score,
      user_email: session.user.email,
    };
    const util = new CorrectionUtil();
    const result = await util.create(testData);
    return NextResponse.json({ success: true, id: result.id });
  } catch (e) {
    return NextResponse.json({ success: false, message: "æ‰¹æ”¹åˆ›å»ºå¤±è´¥", error: String(e) }, { status: 500 });
  }
}